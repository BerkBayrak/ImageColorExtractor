<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Image Color Extractor</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color:#f8f9fa; }
    .color-swatch { width:32px; height:24px; border-radius:4px; border:1px solid #ddd; display:inline-block; margin-right:8px; }
    #preview img { max-width:100%; border-radius:8px; }
    table td, table th { vertical-align:middle; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h3 class="card-title mb-3">Image Color Extractor</h3>
      <p class="text-muted small">Upload an image to extract all main colors (RGB & HEX). Everything runs in your browser — no server upload.</p>

      <!-- Image upload -->
      <div class="mb-3">
        <label for="file" class="form-label">Choose an image</label>
        <input id="file" type="file" accept="image/*" class="form-control">
      </div>

      <!-- Settings -->
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Color precision</label>
          <input id="precision" type="range" min="2" max="6" step="1" value="4" class="form-range">
          <small class="text-muted">Current: <span id="precisionVal">4</span> (lower = more colors)</small>
        </div>
        <div class="col-md-4">
          <label class="form-label">Max resize edge (px)</label>
          <input id="maxEdge" type="number" min="100" max="2000" step="50" value="800" class="form-control">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button id="processBtn" class="btn btn-primary w-100" disabled>Extract Colors</button>
        </div>
      </div>

      <!-- Image preview -->
      <div id="preview" class="mt-4"></div>

      <!-- Info -->
      <div id="info" class="text-muted small mt-2"></div>

      <!-- Results -->
      <div id="results" class="mt-4"></div>

      <!-- Export buttons -->
      <div class="mt-3 d-flex gap-2">
        <button id="downloadTxtBtn" class="btn btn-outline-secondary" disabled>Download TXT</button>
        <button id="downloadGplBtn" class="btn btn-outline-secondary" disabled>Download Aseprite Palette</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden canvas -->
<canvas id="canvas" style="display:none;"></canvas>

<script>
    //Author Lycradiata
(function(){
  const fileInput = document.getElementById('file');
  const processBtn = document.getElementById('processBtn');
  const downloadTxtBtn = document.getElementById('downloadTxtBtn');
  const downloadGplBtn = document.getElementById('downloadGplBtn');
  const precisionInput = document.getElementById('precision');
  const precisionVal = document.getElementById('precisionVal');
  const maxEdgeInput = document.getElementById('maxEdge');
  const preview = document.getElementById('preview');
  const info = document.getElementById('info');
  const results = document.getElementById('results');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  let lastRows = null; // store extracted rows
  let lastFilename = null;

  precisionInput.addEventListener('input', ()=> precisionVal.textContent = precisionInput.value);

  // Handle file selection
  fileInput.addEventListener('change', ()=> {
    results.innerHTML = '';
    info.textContent = '';
    lastRows = null;
    downloadTxtBtn.disabled = true;
    downloadGplBtn.disabled = true;
    if (fileInput.files.length) {
      processBtn.disabled = false;
      showPreview(fileInput.files[0]);
    }
  });

  // Process button
  processBtn.addEventListener('click', async ()=> {
    if (!fileInput.files.length) return;
    processBtn.disabled = true;
    results.innerHTML = '<div class="text-muted">Processing...</div>';
    try {
      const file = fileInput.files[0];
      lastFilename = file.name;
      const img = await loadImageFromFile(file);
      const maxEdge = Math.max(100, Math.min(2000, Number(maxEdgeInput.value) || 800));
      const resizeScale = Math.max(1, Math.max(img.width, img.height) / maxEdge);
      const w = Math.round(img.width / resizeScale);
      const h = Math.round(img.height / resizeScale);
      canvas.width = w;
      canvas.height = h;
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(img, 0, 0, w, h);

      const imageData = ctx.getImageData(0,0,w,h);
      const pixels = imageData.data;
      const precision = Number(precisionInput.value) || 4;
      const shift = precision;
      const buckets = new Map();
      let total = 0;

      // Iterate pixels
      for (let i=0; i<pixels.length; i+=4) {
        const a = pixels[i+3];
        if (a === 0) continue; // ignore fully transparent
        const r = pixels[i], g = pixels[i+1], b = pixels[i+2];
        total++;
        const kr = r >> shift, kg = g >> shift, kb = b >> shift;
        const key = (kr<<16) | (kg<<8) | kb;
        if (!buckets.has(key)) buckets.set(key,{count:0,rSum:0,gSum:0,bSum:0});
        const entry = buckets.get(key);
        entry.count++; entry.rSum+=r; entry.gSum+=g; entry.bSum+=b;
      }

      // Build rows
      const rows = [];
      for (const [key,v] of buckets.entries()) {
        const avgR = Math.round(v.rSum / v.count);
        const avgG = Math.round(v.gSum / v.count);
        const avgB = Math.round(v.bSum / v.count);
        rows.push({
          count:v.count, percent:(v.count/total*100),
          r:avgR, g:avgG, b:avgB,
          hex: rgbToHex(avgR,avgG,avgB)
        });
      }
      rows.sort((a,b)=>b.count-a.count);

      // Render results
      renderTable(rows, total, file.name);
      info.textContent = `Done. Total sampled pixels: ${total.toLocaleString()} — Buckets: ${rows.length}`;

      // Save for export
      lastRows = rows;
      downloadTxtBtn.disabled = false;
      downloadGplBtn.disabled = false;
    } catch(err) {
      console.error(err);
      results.innerHTML = `<div class="text-danger">Error: ${err.message||err}</div>`;
      info.textContent = '';
    } finally {
      processBtn.disabled = false;
    }
  });

  // Export TXT
  downloadTxtBtn.addEventListener('click', ()=> {
    if (!lastRows) return;
    let lines = [];
    lastRows.forEach((r,i)=>{
      lines.push(`${i+1}. ${r.hex.toUpperCase()} | RGB(${r.r},${r.g},${r.b}) | Count: ${r.count} | ${r.percent.toFixed(2)}%`);
    });
    downloadFile(lines.join('\n'), makeFilename('colors.txt'));
  });

  // Export Aseprite Palette (.gpl format)
  downloadGplBtn.addEventListener('click', ()=> {
    if (!lastRows) return;
    const header = [
      'GIMP Palette',
      'Name: Extracted Palette',
      'Columns: 8',
      '#'
    ];
    const lines = [...header];
    lastRows.forEach(r=>{
      lines.push(`${r.r} ${r.g} ${r.b}\t${r.hex.toUpperCase()}`);
    });
    downloadFile(lines.join('\n'), makeFilename('palette.gpl'));
  });

  // Helpers
  function showPreview(file){
    const url = URL.createObjectURL(file);
    preview.innerHTML = `<div class="card mt-3"><div class="card-body"><strong>Preview:</strong><br><img src="${url}" alt="preview"></div></div>`;
  }
  function loadImageFromFile(file){
    return new Promise((res,rej)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload=()=>{URL.revokeObjectURL(url);res(img);};
      img.onerror=()=>{URL.revokeObjectURL(url);rej(new Error("Image load failed."));};
      img.src=url;
    });
  }
  function rgbToHex(r,g,b){ return '#' + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join(''); }
  function renderTable(rows,total,filename){
    let html = `<h5>Colors in ${escapeHtml(filename)}</h5>
    <table class="table table-sm table-striped"><thead>
      <tr><th>#</th><th>Color</th><th>HEX</th><th>RGB</th><th>Count</th><th>%</th></tr>
    </thead><tbody>`;
    rows.forEach((r,i)=>{
      html += `<tr>
        <td>${i+1}</td>
        <td><span class="color-swatch" style="background:${r.hex}"></span></td>
        <td>${r.hex.toUpperCase()}</td>
        <td>${r.r}, ${r.g}, ${r.b}</td>
        <td>${r.count.toLocaleString()}</td>
        <td>${r.percent.toFixed(2)}%</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    results.innerHTML = html;
  }
  function downloadFile(content,filename){
    const blob = new Blob([content],{type:'text/plain;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function makeFilename(ext){
    const base = lastFilename ? lastFilename.replace(/\.[^.]+$/,'') : 'image';
    return base + '_' + ext;
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }
})();
</script>
</body>
</html>
